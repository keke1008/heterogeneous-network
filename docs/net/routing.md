# ルーティング層

フレームを任意のノードへ届ける

## ノードID

ノードID．フレームサイズ節約のためサイズは可変長．

別に一意であれば適当に割り振ってもよいのだが，Arduino同士でダブりなく割り振るのは難しいので，
「接続されているメディアのローカルアドレス」をIDとして利用している．

そのため，実際は適当なローカルアドレスが一つ選ばれてIDとなる．
ローカルアドレスの長さはメディアによって異なるので，ノードIDも可変長になる．

レイアウトは「識別番号(1byte)」+「アドレス(0~6byte)」となっている．

| 識別番号 | アドレス           | サイズ(byte) | 備考                                   |
| -------- | ------------------ | ------------ | -------------------------------------- |
| 0xFF     | (ブロードキャスト) | 0            | ブロードキャストで送信する際に使用する |
| 0x01     | シリアル通信       | 1            |                                        |
| 0x02     | UHF                | 1            |                                        |
| 0x03     | Wi-Fi              | 6            | IPv4アドレス+ポート番号(2byte)         |

## コスト

## Neighbor

自身のノードと直接通信できるノードを管理するプロトコル．

### プロトコル番号

1

### プロトコル

### フレームレイアウト

#### フレームタイプ

| タイプ    | 値  |
| --------- | --- |
| Hello     | 1   |
| Hello Ack | 2   |
| Goodbye   | 3   |

#### Hello / Hello Ack

| #   | フィールド名                     | サイズ(byte) |
| --- | -------------------------------- | ------------ |
| 1   | フレームタイプ                   | 1            |
| 2   | 送信者のノードID                 | 可変長       |
| 3   | 送信者のノードコスト             | 2            |
| 4   | 送信者と受信者の間のリンクコスト | 2            |

#### Goodbye

| #   | フィールド名     | サイズ(byte) |
| --- | ---------------- | ------------ |
| 1   | フレームタイプ   | 1            |
| 2   | 送信者のノードID | 2            |

## Reactive

宛先のノードまでのルートを探索するプロトコル．

### プロトコル番号

2

### プロトコル

### フレームレイアウト

#### フレームタイプ

| タイプ  | 値  |
| ------- | --- |
| Request | 1   |
| Reply   | 2   |

#### レイアウト

| #   | フィールド名         | サイズ(byte) | 備考                                                 |
| --- | -------------------- | ------------ | ---------------------------------------------------- |
| 1   | フレームタイプ       | 1            |                                                      |
| 2   | フレームID           | 2            |                                                      |
| 3   | トータルコスト       | 2            | 探索を開始したノードから，送信元のノードまでのコスト |
| 4   | ソースノードのID     | 可変         | 探索を開始したノード                                 |
| 5   | ターゲットノードのID | 可変         | 探索対象のノード                                     |
| 6   | 送信ノードのID       | 可変         | このフレームを送信したノード                         |

## Routing

離れたノードに対してデータを送信するプロトコル．

上位のプロトコルをカプセル化する．

### プロトコル

### ヘッダレイアウト

| #   | フィールド名     | サイズ(byte) |
| --- | ---------------- | ------------ |
| 1   | 送信元ノードのID | 可変         |
| 2   | 宛先ノードのID   | 可変         |
